# Deployment Guide: Vercel (Frontend) + Railway (Backend)

This guide provides step-by-step instructions for deploying the BlinkBazaar monorepo with the frontend on Vercel and the backend on Railway.

## Prerequisites

- GitHub repository connected to both Vercel and Railway
- PostgreSQL database (Railway can provide this)
- Solana RPC endpoint (use public or get from Helius/QuickNode)

---

## Part 1: Deploy Backend to Railway

### Step 1: Create Railway Project

1. Go to [Railway Dashboard](https://railway.app/dashboard)
2. Click **"New Project"**
3. Select **"Deploy from GitHub repo"**
4. Choose your repository: `BlinkBazaar`
5. Railway will automatically detect the monorepo structure

### Step 2: Configure API Service

1. Railway should auto-detect the `@blink402/api` package
2. If not, click **"New Service"** � **"GitHub Repo"** � Select your repo
3. In **Service Settings**:
   - **Service Name**: `api` or `blink402-api`
   - **Root Directory**: Leave empty (railway.toml handles this)
   - **Config File Path**: `/apps/api/railway.toml`

### Step 3: Add PostgreSQL Database

1. In your Railway project, click **"New Service"**
2. Select **"Database"** � **"PostgreSQL"**
3. Railway will automatically create `DATABASE_URL` variable
4. The API service will automatically link to this database

### Step 4: Set Environment Variables

In Railway API service settings � **Variables** tab, add:

**Required:**
```
DATABASE_URL=(auto-generated by Railway Postgres)
PORT=3001
HOST=0.0.0.0
NODE_ENV=production
```

**Optional but Recommended:**
```
SOLANA_RPC_URL=https://api.mainnet-beta.solana.com
REDIS_URL=(if you add Redis service)
```

### Step 5: Deploy

1. Click **"Deploy"** or push to GitHub
2. Railway will:
   - Install dependencies with pnpm
   - Build shared packages (@blink402/types, solana, database, config)
   - Build API
   - Start with `node apps/api/dist/index.js`
3. Wait for deployment to complete (~2-3 minutes)
4. Note your Railway API URL: `https://blink402-api.up.railway.app`

### Step 6: Verify Backend Deployment

Test the health endpoint:
```bash
curl https://your-api.up.railway.app/health
```

Expected response:
```json
{
  "status": "healthy",
  "uptime": 123.456,
  "timestamp": "2025-01-04T..."
}
```

---

## Part 2: Deploy Frontend to Vercel

### Step 1: Import Project

1. Go to [Vercel Dashboard](https://vercel.com/dashboard)
2. Click **"Add New..."** � **"Project"**
3. Import your GitHub repository: `BlinkBazaar`
4. Vercel will detect it's a monorepo

### Step 2: Configure Project Settings

**During import or in Project Settings:**

1. **Framework Preset**: Next.js (auto-detected)
2. **Root Directory**: `apps/web`
   - Click **"Edit"** next to Root Directory
   - Select `apps/web` from dropdown
3. **Build & Development Settings**:
   - Build Command: `pnpm build` (auto-detected from vercel.json)
   - Output Directory: `.next` (auto-detected)
   - Install Command: `pnpm install --frozen-lockfile` (auto-detected)

### Step 3: Set Environment Variables

In Vercel Project Settings � **Environment Variables**, add:

**Required:**
```
NEXT_PUBLIC_API_URL=https://blink402-production.up.railway.app
NEXT_PUBLIC_APP_URL=https://blink402.dev
NEXT_PUBLIC_SITE_URL=https://blink402.dev

DATABASE_URL=(same as Railway - if using Next.js API routes)

NEXT_PUBLIC_SOLANA_NETWORK=mainnet-beta
NEXT_PUBLIC_SOLANA_RPC_URL=https://api.mainnet-beta.solana.com
NEXT_PUBLIC_USDC_MINT=EPjFWdd5AufqSSqeM2qN1xzybapC8G4wEGGkZwyTDt1v
```

**For All Environments:** Check "Production", "Preview", and "Development"

### Step 4: Deploy

1. Click **"Deploy"**
2. Vercel will:
   - Install dependencies with pnpm (workspace aware)
   - Build Next.js app with standalone output
   - Deploy to global edge network
3. Wait for deployment (~1-2 minutes)
4. Your app is live at: `https://blink402.dev`

### Step 5: Verify Frontend Deployment

1. Visit your Vercel URL
2. Check that the app loads
3. Open browser console - check for API connection errors
4. Test connecting wallet and browsing Blinks

---

## Part 3: Database Setup

### Option A: Use Railway PostgreSQL (Recommended)

Railway automatically provisions the database and sets `DATABASE_URL`. You just need to run migrations:

1. **Locally** with Railway CLI:
   ```bash
   # Install Railway CLI
   npm i -g @railway/cli

   # Login and link to your project
   railway login
   railway link

   # Run migrations (from monorepo root)
   railway run psql $DATABASE_URL < schema.sql
   ```

2. **Or via Railway Dashboard**:
   - Click PostgreSQL service � **"Data"** tab
   - Click **"Query"** button
   - Paste contents of `schema.sql` and execute

### Option B: External PostgreSQL

If using external database (Supabase, Neon, etc.):

1. Create database and get connection string
2. Add `DATABASE_URL` to both Railway and Vercel environment variables
3. Run migrations locally:
   ```bash
   psql "your-database-url" < schema.sql
   ```

---

## Part 4: Post-Deployment Configuration

### Update API URL in Frontend

Make sure `NEXT_PUBLIC_API_URL` points to your Railway API:

```bash
# In Vercel Environment Variables
NEXT_PUBLIC_API_URL=https://blink402-api.up.railway.app
```

Redeploy frontend after changing this variable.

### Configure CORS on Backend

The API (`apps/api/src/index.ts`) should already have CORS configured for Vercel:

```typescript
await fastify.register(cors, {
  origin: [
    'https://blink402.dev',
    'https://www.blink402.dev',
    'http://localhost:3000', // Local development
  ],
  credentials: true,
})
```

Update the origin array with your actual Vercel domain.

### Set Up Custom Domains (Optional)

**Frontend (Vercel):**
1. Project Settings � **Domains**
2. Add your domain: `blink402.com`
3. Update DNS records as instructed

**Backend (Railway):**
1. Service Settings � **Domains**
2. Click **"Generate Domain"** or add custom domain
3. Update `NEXT_PUBLIC_API_URL` in Vercel to use new domain

---

## Part 5: Monitoring & Troubleshooting

### Railway Logs

View real-time logs:
```bash
railway logs
```

Or in Railway Dashboard � Service � **"Deployments"** tab � Click deployment � **"View Logs"**

### Vercel Logs

1. Vercel Dashboard � Project � **"Deployments"**
2. Click deployment � **"Logs"** or **"Runtime Logs"**
3. Check for build errors or runtime issues

### Common Issues

#### Issue: "DATABASE_URL not configured"
**Solution:** Ensure `DATABASE_URL` is set in Railway environment variables and Postgres service is running.

#### Issue: "CORS error" in browser
**Solution:**
1. Check `NEXT_PUBLIC_API_URL` is correct in Vercel
2. Verify CORS origins in `apps/api/src/index.ts` include your Vercel domain
3. Redeploy backend after updating CORS

#### Issue: "Module not found @blink402/..."
**Solution:**
1. Ensure `pnpm-lock.yaml` is committed to git
2. Check railway.toml buildCommand builds all packages
3. Verify workspace dependencies in package.json use `workspace:*`

#### Issue: Vercel build fails with "Command not found"
**Solution:**
1. Check vercel.json is in `apps/web/` directory
2. Ensure Root Directory is set to `apps/web` in Vercel project settings
3. Verify `pnpm-lock.yaml` exists at repository root

---

## Part 6: CI/CD Workflow

### Automatic Deployments

**GitHub Push:**
- Push to `main` branch � deploys to Production
- Push to other branches � creates Preview deployment (Vercel) / Staging (Railway)

**Pull Requests:**
- Vercel creates preview deployment automatically
- Railway can be configured to deploy PR environments

### Manual Deployments

**Vercel CLI:**
```bash
cd apps/web
vercel --prod
```

**Railway CLI:**
```bash
cd apps/api
railway up
```

---

## Environment Variables Reference

### Backend (Railway) - Required

| Variable | Example | Description |
|----------|---------|-------------|
| `DATABASE_URL` | `postgresql://user:pass@host/db` | PostgreSQL connection string (auto-generated) |
| `PORT` | `3001` | API server port |
| `HOST` | `0.0.0.0` | API server host |
| `NODE_ENV` | `production` | Environment mode |

### Backend (Railway) - Optional

| Variable | Example | Description |
|----------|---------|-------------|
| `SOLANA_RPC_URL` | `https://api.mainnet-beta.solana.com` | Solana RPC endpoint |
| `REDIS_URL` | `redis://default:pass@host:port` | Redis for rate limiting |

### Frontend (Vercel) - Required

| Variable | Example | Description |
|----------|---------|-------------|
| `NEXT_PUBLIC_API_URL` | `https://api.blink402.com` | Backend API URL (Railway) |
| `NEXT_PUBLIC_APP_URL` | `https://blink402.com` | Frontend URL (Vercel) |
| `NEXT_PUBLIC_SITE_URL` | `https://blink402.com` | Site URL for metadata |
| `NEXT_PUBLIC_SOLANA_NETWORK` | `mainnet-beta` | Solana network |
| `NEXT_PUBLIC_SOLANA_RPC_URL` | `https://api.mainnet-beta.solana.com` | Solana RPC for client |
| `NEXT_PUBLIC_USDC_MINT` | `EPjFW...` | USDC token mint address |

### Frontend (Vercel) - Optional

| Variable | Example | Description |
|----------|---------|-------------|
| `DATABASE_URL` | `postgresql://...` | Only if using Next.js API routes |

---

## Quick Deploy Checklist

- [ ] Backend deployed to Railway
- [ ] PostgreSQL database provisioned
- [ ] Database migrations run (`schema.sql`)
- [ ] Backend environment variables set
- [ ] Backend health check passes (`/health`)
- [ ] Frontend deployed to Vercel
- [ ] Root Directory set to `apps/web` in Vercel
- [ ] Frontend environment variables set
- [ ] `NEXT_PUBLIC_API_URL` points to Railway API
- [ ] CORS configured in backend for Vercel domain
- [ ] Frontend loads without errors
- [ ] Wallet connection works
- [ ] Test payment flow end-to-end

---

## Support

If you encounter issues:

1. Check logs in Railway and Vercel dashboards
2. Verify all environment variables are set correctly
3. Ensure database is accessible and migrations are run
4. Test API health endpoint directly
5. Check browser console for frontend errors

**Configuration Files:**
- Frontend: `apps/web/vercel.json`
- Backend: `apps/api/railway.toml`
- Environment example: `.env.example`
